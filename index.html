<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>塾入退室管理</title>
    <link rel="stylesheet" href="style.css" />

    <!-- PWA関連のメタタグ追加 -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4a90e2" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />

    <!-- iOSでのスプラッシュスクリーン -->
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-640x1136.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-750x1334.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1242x2208.png"
      media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1125x2436.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1536x2048.png"
      media="(min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1668x2224.png"
      media="(min-device-width: 834px) and (max-device-width: 834px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-2048x2732.png"
      media="(min-device-width: 1024px) and (max-device-width: 1024px) and (-webkit-device-pixel-ratio: 2)"
    />
  </head>
  <body>
    <div class="container">
      <h1>入退室管理</h1>

      <div id="status" class="status-box">
        <p>カードをかざしてください</p>
      </div>

      <button id="manualButton" class="secondary-button">手動入力</button>

      <!-- UID読み取り画面への遷移ボタンを追加 -->
      <a href="uid-reader.html" class="navigation-button">カードUID読み取り</a>

      <div id="offline-message" class="hidden">
        <p>オフラインモードです</p>
      </div>
    </div>

    <script>
      // Service Workerの登録
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const statusBox = document.getElementById("status");
        const manualButton = document.getElementById("manualButton");
        const offlineMessage = document.getElementById("offline-message");
        let isReading = false;
        let timeoutId = null;
        let lastReadTime = Date.now();

        // オンライン・オフライン状態の監視
        window.addEventListener("online", handleNetworkChange);
        window.addEventListener("offline", handleNetworkChange);

        function handleNetworkChange() {
          if (navigator.onLine) {
            offlineMessage.classList.add("hidden");
          } else {
            offlineMessage.classList.remove("hidden");
          }
        }

        // 初期チェック
        handleNetworkChange();

        // 自動的にNFCスキャンを開始
        async function startNfcScan() {
          if ("NDEFReader" in window) {
            try {
              statusBox.innerHTML = "<p>カードをかざしてください</p>";
              statusBox.className = "status-box scanning";

              const ndef = new NDEFReader();
              await ndef.scan();

              ndef.addEventListener("reading", ({ serialNumber }) => {
                if (serialNumber && !isReading) {
                  isReading = true;
                  lastReadTime = Date.now();

                  // 連続読み取り防止のための音やフィードバック
                  playBeepSound();

                  // UIDを取得
                  sendAttendanceData(serialNumber);

                  // 3秒間は次の読み取りを無効に
                  timeoutId = setTimeout(() => {
                    isReading = false;
                  }, 3000);
                }
              });

              console.log("NFC読み取りを開始しました");
            } catch (error) {
              statusBox.innerHTML = `<p>エラー: ${error.message}</p>`;
              statusBox.className = "status-box error";

              // 5秒後に再試行
              setTimeout(startNfcScan, 5000);
            }
          } else {
            statusBox.innerHTML =
              "<p>このブラウザはNFC APIをサポートしていません</p>";
            statusBox.className = "status-box error";
          }
        }

        // 読み取り時の音を鳴らす
        function playBeepSound() {
          const beep = new Audio(
            "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
          );
          beep
            .play()
            .catch((e) => console.log("音の再生ができませんでした", e));
        }

        // 成功時の音
        function playSuccessSound() {
          const success = new Audio(
            "https://assets.mixkit.co/active_storage/sfx/213/213-preview.mp3"
          );
          success
            .play()
            .catch((e) => console.log("音の再生ができませんでした", e));
        }

        // エラー時の音
        function playErrorSound() {
          const error = new Audio(
            "https://assets.mixkit.co/active_storage/sfx/132/132-preview.mp3"
          );
          error
            .play()
            .catch((e) => console.log("音の再生ができませんでした", e));
        }

        // 手動入力ボタン
        manualButton.addEventListener("click", () => {
          const cardId = prompt("カードIDを入力してください:");
          if (cardId) {
            sendAttendanceData(cardId);
          }
        });

        // サーバーにデータ送信
        async function sendAttendanceData(cardId) {
          statusBox.innerHTML = "<p>処理中...</p>";

          try {
            const response = await fetch(
              "http://localhost:8080/api/attendance", //***ここは実環境に合わせる***
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ cardId }),
                mode: "cors", // CORSモードを明示的に指定
              }
            );

            const data = await response.json();

            if (data.success) {
              const action = data.type === "ENTRY" ? "入室" : "退室";
              statusBox.innerHTML = `
                <h2>${data.studentName}さん</h2>
                <p>${action}を記録しました</p>
                <p>${new Date().toLocaleTimeString()}</p>
              `;
              statusBox.className = "status-box success";
              playSuccessSound();

              // 5秒後に待機画面に戻る
              setTimeout(() => {
                statusBox.innerHTML = "<p>カードをかざしてください</p>";
                statusBox.className = "status-box scanning";
              }, 5000);
            } else {
              statusBox.innerHTML = `<p>エラー: ${
                data.message || "不明なエラー"
              }</p>`;
              statusBox.className = "status-box error";
              playErrorSound();

              // 3秒後に待機画面に戻る
              setTimeout(() => {
                statusBox.innerHTML = "<p>カードをかざしてください</p>";
                statusBox.className = "status-box scanning";
              }, 3000);
            }
          } catch (error) {
            statusBox.innerHTML = `<p>通信エラー: ${error.message}</p>`;
            statusBox.className = "status-box error";
            playErrorSound();

            // 3秒後に待機画面に戻る
            setTimeout(() => {
              statusBox.innerHTML = "<p>カードをかざしてください</p>";
              statusBox.className = "status-box scanning";
            }, 3000);
          }
        }

        // アプリ起動時にNFCスキャンを自動的に開始
        startNfcScan();

        // 定期的に読み取り状態をリセット (バグ対策)
        setInterval(() => {
          if (isReading && Date.now() - lastReadTime > 10000) {
            isReading = false;
          }
        }, 10000);

        // ページがフォーカスを失ったり再取得した時にNFCスキャンを再開
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            // 念のため再スキャン
            startNfcScan();
          }
        });
      });
    </script>
  </body>
</html>
