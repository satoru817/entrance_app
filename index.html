<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>塾入退室管理</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>入退室管理</h1>

      <div id="status" class="status-box">
        <p>NFCタグをスキャンするには下のボタンをタップ</p>
      </div>

      <button id="scanButton" class="primary-button">NFCスキャン開始</button>
      <button id="manualButton" class="secondary-button">手動入力</button>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const statusBox = document.getElementById("status");
        const scanButton = document.getElementById("scanButton");
        const manualButton = document.getElementById("manualButton");

        // NFC読み取りボタン
        scanButton.addEventListener("click", async () => {
          statusBox.innerHTML = "<p>NFCタグをスマホにかざしてください...</p>";
          statusBox.className = "status-box scanning";

          if ("NDEFReader" in window) {
            try {
              const ndef = new NDEFReader();
              await ndef.scan();

              ndef.addEventListener("reading", ({ serialNumber }) => {
                if (serialNumber) {
                  // UIDを取得
                  sendAttendanceData(serialNumber);
                }
              });
            } catch (error) {
              statusBox.innerHTML = `<p>エラー: ${error.message}</p>`;
              statusBox.className = "status-box error";
            }
          } else {
            statusBox.innerHTML =
              "<p>このブラウザはNFC APIをサポートしていません</p>";
            statusBox.className = "status-box error";
          }
        });

        // 手動入力ボタン
        manualButton.addEventListener("click", () => {
          const cardId = prompt("カードIDを入力してください:");
          if (cardId) {
            sendAttendanceData(cardId);
          }
        });

        // サーバーにデータ送信
        async function sendAttendanceData(cardId) {
          statusBox.innerHTML = "<p>処理中...</p>";

          try {
            const response = await fetch(
              "https://your-server.com/api/attendance",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ cardId }),
              }
            );

            const data = await response.json();

            if (data.success) {
              const action = data.type === "ENTRY" ? "入室" : "退室";
              statusBox.innerHTML = `
              <h2>${data.studentName}さん</h2>
              <p>${action}を記録しました</p>
              <p>${new Date().toLocaleTimeString()}</p>
            `;
              statusBox.className = "status-box success";
            } else {
              statusBox.innerHTML = `<p>エラー: ${
                data.message || "不明なエラー"
              }</p>`;
              statusBox.className = "status-box error";
            }
          } catch (error) {
            statusBox.innerHTML = `<p>通信エラー: ${error.message}</p>`;
            statusBox.className = "status-box error";
          }
        }
      });
    </script>
  </body>
</html>
