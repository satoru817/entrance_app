<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>塾入退室管理</title>
    <link rel="stylesheet" href="style.css" />

    <!-- PWA関連のメタタグ追加 -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4a90e2" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="icons/android-icon-192x192.png" />

    <!-- iOSでのスプラッシュスクリーン -->
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-640x1136.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-750x1334.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1242x2208.png"
      media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1125x2436.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1536x2048.png"
      media="(min-device-width: 768px) and (max-device-width: 1024px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-1668x2224.png"
      media="(min-device-width: 834px) and (max-device-width: 834px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="icons/splash-2048x2732.png"
      media="(min-device-width: 1024px) and (max-device-width: 1024px) and (-webkit-device-pixel-ratio: 2)"
    />
  </head>
  <body>
    <div class="container">
      <h1>入退室管理</h1>

      <div id="status" class="status-box scanning">
        <p>NFCスキャンを実行中...</p>
        <p>カードをかざしてください</p>
      </div>

      <!-- スキャンの状態制御ボタン -->
      <button id="toggleScanButton" class="primary-button">一時停止</button>
      <button id="manualButton" class="secondary-button">手動入力</button>

      <div id="scanStatus" class="scan-status active">スキャン実行中</div>

      <!-- UID読み取り画面への遷移ボタン -->
      <a href="uid-reader.html" class="navigation-button">カードUID読み取り</a>

      <div id="offline-message" class="hidden">
        <p>オフラインモードです</p>
      </div>
    </div>

    <script>
      // Service Workerの登録
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./service-worker.js")
            .then((registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        // 要素の取得
        const statusBox = document.getElementById("status");
        const toggleScanButton = document.getElementById("toggleScanButton");
        const manualButton = document.getElementById("manualButton");
        const offlineMessage = document.getElementById("offline-message");
        const scanStatus = document.getElementById("scanStatus");

        // 変数の初期化
        let isReading = false;
        let timeoutId = null;
        let ndefReader = null;
        let isScanning = true;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 2000; // 2秒

        // オンライン/オフライン状態の監視
        window.addEventListener("online", updateOnlineStatus);
        window.addEventListener("offline", updateOnlineStatus);

        function updateOnlineStatus() {
          if (navigator.onLine) {
            offlineMessage.classList.add("hidden");
          } else {
            offlineMessage.classList.remove("hidden");
          }
        }

        // 初期状態の確認
        updateOnlineStatus();

        // 自動的にNFCスキャンを開始
        startNfcScan();

        // NFC読み取り関数
        async function startNfcScan() {
          if ("NDEFReader" in window) {
            try {
              statusBox.innerHTML = "<p>カードをかざしてください</p>";
              statusBox.className = "status-box scanning";
              scanStatus.textContent = "スキャン実行中";
              scanStatus.className = "scan-status active";
              toggleScanButton.textContent = "一時停止";

              // 既存のリーダーがあれば一度解放
              if (ndefReader) {
                try {
                  // NDEFReaderのスキャン停止方法がないため、
                  // 新しいインスタンスを作成して古いものを破棄
                  ndefReader = null;
                } catch (e) {
                  console.log("Previous reader cleanup failed:", e);
                }
              }

              ndefReader = new NDEFReader();
              await ndefReader.scan();
              console.log("NFCスキャン開始成功");
              reconnectAttempts = 0; // 成功したらリセット

              ndefReader.addEventListener("reading", ({ serialNumber }) => {
                if (serialNumber && !isReading) {
                  isReading = true;
                  console.log("カード読み取り:", serialNumber);

                  // 連続読み取り防止のための音やフィードバック
                  playBeepSound();

                  // UIDを取得
                  sendAttendanceData(serialNumber);

                  // 3秒間は次の読み取りを無効に
                  clearTimeout(timeoutId);
                  timeoutId = setTimeout(() => {
                    isReading = false;
                  }, 3000);
                }
              });

              ndefReader.addEventListener("error", (error) => {
                console.error("NFC読み取りエラー:", error);
                if (isScanning) {
                  attemptReconnect();
                }
              });
            } catch (error) {
              console.error("NFCスキャンエラー:", error);
              statusBox.innerHTML = `<p>エラー: ${error.message}</p><p>自動的に再接続します...</p>`;
              statusBox.className = "status-box error";

              if (isScanning) {
                attemptReconnect();
              }
            }
          } else {
            statusBox.innerHTML =
              "<p>このブラウザはNFC APIをサポートしていません</p>";
            statusBox.className = "status-box error";
            scanStatus.textContent = "NFCサポートなし";
            scanStatus.className = "scan-status error";
          }
        }

        // 再接続を試みる関数
        function attemptReconnect() {
          reconnectAttempts++;
          if (reconnectAttempts <= MAX_RECONNECT_ATTEMPTS) {
            console.log(
              `再接続を試みます (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`
            );
            setTimeout(() => {
              if (isScanning) {
                startNfcScan();
              }
            }, RECONNECT_DELAY);
          } else {
            console.error("最大再接続試行回数に達しました");
            statusBox.innerHTML = "<p>接続エラー: 再読み込みしてください</p>";
            statusBox.className = "status-box error";
            scanStatus.textContent = "接続エラー";
            scanStatus.className = "scan-status error";

            // 30秒後に再試行
            setTimeout(() => {
              if (isScanning) {
                reconnectAttempts = 0;
                startNfcScan();
              }
            }, 30000);
          }
        }

        // スキャンの切り替え
        function toggleScan() {
          isScanning = !isScanning;

          if (isScanning) {
            toggleScanButton.textContent = "一時停止";
            startNfcScan();
          } else {
            toggleScanButton.textContent = "スキャン再開";
            statusBox.innerHTML = "<p>NFCスキャンは一時停止しています</p>";
            statusBox.className = "status-box";
            scanStatus.textContent = "スキャン停止中";
            scanStatus.className = "scan-status inactive";
          }
        }

        // 読み取り時の音を鳴らす
        function playBeepSound() {
          const beep = new Audio(
            "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
          );
          beep
            .play()
            .catch((e) => console.log("音の再生ができませんでした", e));
        }

        // 成功時の音
        function playSuccessSound() {
          const success = new Audio(
            "https://assets.mixkit.co/active_storage/sfx/213/213-preview.mp3"
          );
          success
            .play()
            .catch((e) => console.log("音の再生ができませんでした", e));
        }

        // エラー時の音
        function playErrorSound() {
          const error = new Audio(
            "https://assets.mixkit.co/active_storage/sfx/132/132-preview.mp3"
          );
          error
            .play()
            .catch((e) => console.log("音の再生ができませんでした", e));
        }

        // スキャン切り替えボタンのイベントリスナー
        toggleScanButton.addEventListener("click", toggleScan);

        // 手動入力ボタンのイベントリスナー
        manualButton.addEventListener("click", () => {
          const cardId = prompt("カードIDを入力してください:");
          if (cardId) {
            sendAttendanceData(cardId);
          }
        });

        // サーバーにデータ送信
        async function sendAttendanceData(cardId) {
          statusBox.innerHTML = "<p>処理中...</p>";
          statusBox.className = "status-box processing";

          try {
            // オフライン時の処理
            if (!navigator.onLine) {
              // オフラインデータを保存
              const offlineData = JSON.parse(
                localStorage.getItem("offlineAttendance") || "[]"
              );
              offlineData.push({
                cardId,
                timestamp: new Date().toISOString(),
              });
              localStorage.setItem(
                "offlineAttendance",
                JSON.stringify(offlineData)
              );

              statusBox.innerHTML = `
                <h2>オフラインモード</h2>
                <p>データを一時保存しました</p>
                <p>${new Date().toLocaleTimeString()}</p>
              `;
              statusBox.className = "status-box warning";

              // 5秒後に待機画面に戻る
              setTimeout(() => {
                if (isScanning) {
                  statusBox.innerHTML = "<p>カードをかざしてください</p>";
                  statusBox.className = "status-box scanning";
                }
              }, 5000);

              return;
            }

            // この部分は実際のAPIエンドポイントに変更してください
            const response = await fetch(
              "https://your-server.com/api/attendance",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ cardId }),
              }
            );

            const data = await response.json();

            if (data.success) {
              const action = data.type === "ENTRY" ? "入室" : "退室";
              statusBox.innerHTML = `
                <h2>${data.studentName}さん</h2>
                <p>${action}を記録しました</p>
                <p>${new Date().toLocaleTimeString()}</p>
              `;
              statusBox.className = "status-box success";
              playSuccessSound();

              // 5秒後に待機画面に戻る
              setTimeout(() => {
                if (isScanning) {
                  statusBox.innerHTML = "<p>カードをかざしてください</p>";
                  statusBox.className = "status-box scanning";
                }
              }, 5000);
            } else {
              statusBox.innerHTML = `<p>エラー: ${
                data.message || "不明なエラー"
              }</p>`;
              statusBox.className = "status-box error";
              playErrorSound();

              // 3秒後に待機画面に戻る
              setTimeout(() => {
                if (isScanning) {
                  statusBox.innerHTML = "<p>カードをかざしてください</p>";
                  statusBox.className = "status-box scanning";
                }
              }, 3000);
            }
          } catch (error) {
            console.error("API通信エラー:", error);
            statusBox.innerHTML = `<p>通信エラー: ${error.message}</p>`;
            statusBox.className = "status-box error";
            playErrorSound();

            // 3秒後に待機画面に戻る
            setTimeout(() => {
              if (isScanning) {
                statusBox.innerHTML = "<p>カードをかざしてください</p>";
                statusBox.className = "status-box scanning";
              }
            }, 3000);
          }
        }

        // オフラインデータの同期関数
        async function syncOfflineData() {
          const offlineData = JSON.parse(
            localStorage.getItem("offlineAttendance") || "[]"
          );
          if (offlineData.length === 0) return;

          try {
            // バッチ処理用のエンドポイントを用意すると効率的
            const response = await fetch(
              "https://your-server.com/api/attendance/batch",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ records: offlineData }),
              }
            );

            const result = await response.json();
            if (result.success) {
              localStorage.removeItem("offlineAttendance");
              console.log("オフラインデータを同期しました");
            }
          } catch (error) {
            console.error("オフラインデータの同期に失敗:", error);
          }
        }

        // オンラインに戻った時にデータを同期
        window.addEventListener("online", syncOfflineData);

        // ページがフォーカスを失ったり再取得した時の処理
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            // 表示された時は再接続
            if (isScanning && !ndefReader) {
              isReading = false;
              startNfcScan();
            }
          }
        });

        // 1分ごとにNFCリーダーの状態を確認し、必要に応じて再接続
        setInterval(() => {
          if (isScanning && !isReading) {
            console.log("NFCリーダーの状態をチェック中...");
            // テスト目的でスキャンを再試行
            startNfcScan();
          }
        }, 60000); // 1分
      });
    </script>
  </body>
</html>
